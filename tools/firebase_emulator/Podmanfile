FROM node:20

# Install OpenJDK 21 (instead of default-jdk)
RUN apt-get update && \
    apt-get install -y wget gnupg ca-certificates && \
    mkdir -p /etc/apt/keyrings && \
    wget -O- https://packages.adoptium.net/artifactory/api/gpg/key/public | gpg --dearmor > /etc/apt/keyrings/adoptium.gpg && \
    echo "deb [signed-by=/etc/apt/keyrings/adoptium.gpg] https://packages.adoptium.net/artifactory/deb bookworm main" > /etc/apt/sources.list.d/adoptium.list && \
    apt-get update && \
    apt-get install -y temurin-21-jdk vim && \
    apt-get clean && rm -rf /var/lib/apt/lists/*

# Verify Java version (optional sanity check)
RUN java -version

# Set working directory
WORKDIR /app

# Install Firebase CLI and TypeScript globally
RUN npm install -g firebase-tools typescript ts-node

# Copy Firebase configuration files
COPY firebase.json .
# COPY firestore.rules .

# Expose Firebase emulator ports
EXPOSE 4000 4500 5000 5001 8080 8085 9000 9099 9199

# Start Firebase Emulator
# CMD ["sh", "-c", "firebase emulators:start --project demo-project"]
CMD ["sh", "-c", "cd node-functions && npm install && npm run build && cd .. && firebase emulators:start --project demo-project"]

