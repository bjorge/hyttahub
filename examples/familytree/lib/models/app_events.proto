syntax = "proto3";

enum TreeConnectionType {
  parent = 0;
  child = 1;
  partner = 2;
  exPartner = 3;
  friend = 4;
  pet = 5;
}

message TreeConnection {
  TreeConnectionType type = 1;
  string info = 2;
}

message AppEvent {
  message AddTree { string name = 1; }

  message UpdateTree {
    int32 treeId = 1;
    string name = 2;
  }

  message DeleteTree { int32 treeId = 1; }

  message ReorderTrees {
    repeated int32 treeIds = 1; // the new order of the trees
  }

  message AddTreeMember {
    int32 treeId = 1;
    string name = 2;
  }

  message UpdateTreeMember {
    int32 treeMemberId = 1;
    string name = 2;
  }

  message RemoveTreeMember { int32 treeMemberId = 1; }

  message ReorderTreeMembers {
    int32 treeId = 1;
    repeated int32 treeMemberIds = 2; // the new order of the tree members
  }

  message AddConnection {
    TreeConnection connection = 1;
    int32 fromTreeMemberId = 2;
    int32 toTreeMemberId = 3;
  }

  message UpdateConnection {
    int32 connectionId = 1;
    TreeConnection connection = 2;
  }

  message RemoveConnection { int32 treeConnectionId = 1; }

  message AddPhoto {
    int32 treeMemberId = 1;
    string name = 3; // the original name of the photo
    int32 size = 4;  // the size of the image in bytes
  }

  message DeletePhoto { int32 photoId = 1; }

  message UpdateCaption {
    string caption = 1;
    int32 photoId = 2;
  }

  oneof event_type {
    AddTree addTree = 1;
    UpdateTree updateTree = 2;
    DeleteTree deleteTree = 3;
    ReorderTrees reorderTrees = 4;
    AddTreeMember addTreeMember = 5;
    UpdateTreeMember updateTreeMember = 6;
    RemoveTreeMember removeTreeMember = 7;
    ReorderTreeMembers reorderTreeMembers = 8;
    AddConnection addConnection = 9;
    UpdateConnection updateConnection = 10;
    RemoveConnection removeConnection = 11;
    AddPhoto addPhoto = 12;
    DeletePhoto deletePhoto = 13;
    UpdateCaption updateCaption = 14;
  }
}

// The SubmitAppEvent is passed to the submit bloc handler
// PII (ex. email) is allowed in this message since not stored to immutable
// records
message SubmitAppEvent {
  // the final site event will contain this app event
  message SiteEvent {
    int32 version = 1; // the version of the event, required
    int32 author = 2;  // filled in by the app submit bloc
  }

  AppEvent appEvent = 1;   // the event to store in immutable records, required
  SiteEvent siteEvent = 2; // the version of the event, required
  string authorEmail = 3;  // the author's email, required

  message Image {
    string base64Data = 1;  // the image data
    string name = 2; // the name of the image, used for display
    int32 size = 4;  // the size of the image in bytes
  }

  repeated Image images = 20; // for add photo events, the images to upload
  string deletePhotoUrl =
      21; // for delete photo, the url of the photo to delete
  map<int32, string> photo_urls = 22; // for delete album, photo urls to delete
}

// The AppEventRecord is a representation of the actual record stored in the
// database This record is used just for display purposes in the client
message AppEventRecord {
  string isoDate = 1;
  int32 version = 2;
  AppEvent appEvent = 3;
}
